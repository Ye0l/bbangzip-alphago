<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2021-07-21</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
    <script src="howler.min.js"></script>
    <script src="./jquery.animate-colors-min.js"></script>
    <script src="./speech-commands.min.js"></script>
    <script src="./TM_scripts.js"></script>
    <style>
        .container {
            margin-top: 2em;
        }
        #settings {
            position: absolute;
            bottom: 1em;
            right: 1em;
        }
    </style>
    <!-- =================================================================================================== -->
    <!-- Sound  -->
    <!-- =================================================================================================== -->
    <script>
        var soundBGM = new Howl({
          src: ['./sound/dingdong.mp3'],
          volume: 0.7
        });
        var soundEffect = new Howl({
          src: ['./sound/scanning.mp3'],
          volume: 0.5
        });
        // ===================================================================================================
        // POS부
        // ===================================================================================================

        let price;
        $(document).ready(function(){
            // $.getJSON('Bread_price.json', function(data) {
            //     load_json = data;
            // });
            // console.log(load_json);
            // getJSON은 async가 true이고 수정이 불가능하다고 한다.. 그러니까 데이터를 불러오기전에 console.log가 찍혀서 undefined가 뜨는거였음
            $.ajax({
                url: "Bread_price.json",
                dataType: "json",
                type: "GET",
                async: false,
                success: function(data) {
                    price = data;
                    $.each(data, function(key, value) {
                        price[key] = Number(value);
                    })
                }
            })
            btnMicTestFunc();
            tasklist = new Sequence(10);
            undolist = new Sequence(10);
        });
        let lastInsertItem = "";
        let list = [];
        function POSRefresh() {
            $('#tb').empty();
            for(var i of list) {
                let row = "";
                row += `<tr id='tr_${i[0]}'>`;
                for(var j in i) {
                    row += `<td id='td_${i[0]}_${j}'>${(isNaN(Number(i[j]))? i[j] : insertComma([i[j]]))}</td>`;
                }
                row += '</tr>'
                $('#tb').append(row);
            }
            let sumCount = 0;
            let sumPrice = 0;
            for(var i of list) {
                sumCount += i[2];
                sumPrice += i[3];
            }
            $('#sum')[0].innerHTML = insertComma(sumPrice);
        }

        function insertProduct(product) {
            const item = [product, price[product], 1, price[product]];
            lastInsertItem = product;
            for(var i of list) {
                if(i[0] === product) {
                    i[2]++;
                    i[3] = price[product] * i[2];
                    soundEffect.play();
                    POSRefresh();
                    // return $(`#td_${product}_2`);
                    return $(`#tr_${product} > *`).slice(2);
                }
            }
            list.push(item);
            soundBGM.play();
            POSRefresh();
            tasklist.add({'task': 'insert', 'product': product});
            return $(`#tr_${product}`);
        }

        function removeProduct(product) {
            for(var i in list) {
                if(list[i][0] === product) {
                    list.splice(i);
                }
            }
            POSRefresh();
            return $(`#tr_${product}`);
        }

        function changeProduct(product, amount) {
            const item = [product, price[product], amount, price[product] * amount];
            lastInsertItem = product;
            pre_amount;
            if(lastInsertItem !== "");
                for(var i of list) {
                    if(i[0] === product) {
                        pre_amount = i[2];
                        i[2] = amount;
                        i[3] = price[product] * i[2];
                        soundEffect.play();
                        POSRefresh();
                        // return $(`#td_${product}_2`);
                        return $(`#tr_${product} > *`).slice(2);
                    }
                }
            tasklist.add({'task': 'change', 'product': product, 'pre-amount': pre_amount});
        }

        function micInput(data) {
            switch(data) {
                case "하나":
                    insertAnimation(changeProduct(lastInsertItem, 1));
                    break;
                case "둘":
                    insertAnimation(changeProduct(lastInsertItem, 2));
                    break;
                case "셋":
                    insertAnimation(changeProduct(lastInsertItem, 3));
                    break;
                case "넷":
                    insertAnimation(changeProduct(lastInsertItem, 4));
                    break;
                case "다섯":
                    insertAnimation(changeProduct(lastInsertItem, 5));
                    break;
                case "취소":
                    break;
                case "완료":
                    list = [];
                    POSRefresh();
            }
        }

        function btnMicTestFunc() {
            $('#mictype').keydown(function(key) {
                if (key.keyCode == 13) {
                    console.log('ok');
                    micInput($('#mictype')[0].value);
                }
            });
        }
        // ========================================================================
        // 금액 쉼표넣는 메소드, 과거의 나 감사.
        // ========================================================================
        function insertComma(value) {
            var output = "";
            for(var i=1;i <= String(value).length; i++) {
                output = String(value)[String(value).length-i] + output;
                if(Number.isInteger(i/3))
                    if(i != String(value).length) // 마지막 루프 체크.. 이부분이 없으니 "100,000"이 ",100,000"으로 나오더라 ...
                        output = "," + output;
            }
            return output;
        }

        function undo() {
            task = tasklist.undo();
            switch(task['task']) {
                case 'insert':
                    removeProduct(task['product']);
                    undolist.add({'task': 'remove', 'product': task['product']});
                    break;
                case 'change':
                    changeProduct(task['product'], task['pre-amount']);
                    // undolist
            }
        }

        class Sequence {
            constructor(max_size) {
                if(isNaN(Number(max_size))) return 1;

                this._max_size = max_size;
                this._size = 0;
                this._arr = [];
            }

            add(data) {
                if(this._size >= this._max_size) this._arr.shift();
                this._arr.push(data);
                this._size++;
            }

            undo() {
                return this._arr.pop();
            }

            show() {
                return this._arr;
            }
        }
    </script>
</head>
<body>
    <!-- Video -->
    <div class="container">
        <div class="row">
            <h1>Bakery AI Cashier</h1>
        </div>
        <div class="row">
        <div class="col-4">
            <div class="card">
                <div class="card-body">
                    <button class="btn btn-outline-primary btn-block btn-sm" style="width: 100%;" id="v_startBtn" type="button" onclick="v_init()">Start</button>
                    <button class="btn btn-outline-secondary btn-block btn-sm" style="width: 100%;" id="v_resumeBtn" type="button" onclick="predict_switch=true;">Resume</button>
                    <div id="v_webcam-container"></div>
                    <div id="v_label-container"></div>
                    <div class="progress">
                        <div id="v_progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuemin="0" aria-valuemax="1" style="width: 0%"></div>
                    </div>
        
                    <!-- Audio -->
                    <button class="btn btn-outline-primary btn-sm" style="width: 100%;" id="a_startBtn" type="button" onclick="init()">Start</button>
                    <input id="mictype" type="text" class="form-control">
                    <div id="label-container"></div>
                </div>
            </div>
        </div>
        <div class="col-8" style="height: 100%;">
            <div class="card">
                <div class="card-body">
                    <p style="text-align: center;"><b>입력 상품 목록</b></p>
                    <table class="table" style="text-align: center;">
                        <thead>
                            <tr>
                                <th style="width: 25%;">빵이름</th>
                                <th style="width: 25%;">단가</th>
                                <th style="width: 25%;">갯수</th>
                                <th style="width: 25%;">합계</th>
                            </tr>
                        </thead>
                        <tbody id="tb">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card" style="margin-top: 1em; background-color: rgb(201, 201, 201);">
                <div class="card-body">
                    <table class="table">
                        <tbody>
                            <tr style="font-size: xx-large;">
                                <td style="width: 25%;">합계</td>
                                <td style="text-align: right;">
                                    <span id="sum">0</span>원
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        </div>
    </div>
    <div id='settings'>
        <img src="./icons/settings-solid.svg" alt="Settings" style="width: 40px; height: 40px;">
    </div>
    
</body>
</html>
